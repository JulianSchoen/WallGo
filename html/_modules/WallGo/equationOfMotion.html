

<!DOCTYPE html>
<html class="writer-html5" lang="Python" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WallGo.equationOfMotion &mdash; WallGo  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1e580bb1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #efefef" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/wallgo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../firstExample.html">First example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Collected examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faqs.html">FAQs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/boltzmann.html">BoltzmannSolver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/collisionArray.html">CollisionArray</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/collisionHelpers.html">Collision Helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/config.html">Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/effectivePotential.html">EffectivePotential</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/equationOfMotion.html">EOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/fields.html">Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/freeEnergy.html">FreeEnergy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/genericModel.html">GenericModel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/grid.html">Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/grid3Scales.html">Grid3Scales</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/helpers.html">Helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/hydrodynamics.html">Hydrodynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/hydrodynamicsTemplateModel.html">HydrodynamicsTemplateModel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/interpolatableFunction.html">InterpolatableFunction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/manager.html">WallGoManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/particle.html">Particle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/polynomial.html">Polynomial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/results.html">Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/thermodynamics.html">Thermodynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/utilities.html">WallGoUtils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/potentialTools/effectivePotentialNoResum.html">PotentialTools.EffectivePotentialNoResum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/potentialTools/integrals.html">PotentialTools.Integrals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/potentialTools/utilities.html">PotentialTools.Utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #efefef" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">WallGo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">WallGo.equationOfMotion</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for WallGo.equationOfMotion</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Class for solving the EOM and the hydrodynamic equations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">copy</span>  <span class="c1"># for deepcopy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>

<span class="kn">import</span> <span class="nn">scipy.optimize</span>

<span class="kn">from</span> <span class="nn">.boltzmann</span> <span class="kn">import</span> <span class="n">BoltzmannSolver</span>
<span class="kn">from</span> <span class="nn">.fields</span> <span class="kn">import</span> <span class="n">Fields</span><span class="p">,</span> <span class="n">FieldPoint</span>
<span class="kn">from</span> <span class="nn">.grid3Scales</span> <span class="kn">import</span> <span class="n">Grid3Scales</span>
<span class="kn">from</span> <span class="nn">.helpers</span> <span class="kn">import</span> <span class="n">gammaSq</span><span class="p">,</span> <span class="n">nextStepDeton</span>
<span class="kn">from</span> <span class="nn">.hydrodynamics</span> <span class="kn">import</span> <span class="n">Hydrodynamics</span>
<span class="kn">from</span> <span class="nn">.polynomial</span> <span class="kn">import</span> <span class="n">Polynomial</span>
<span class="kn">from</span> <span class="nn">.thermodynamics</span> <span class="kn">import</span> <span class="n">Thermodynamics</span>
<span class="kn">from</span> <span class="nn">.containers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BoltzmannDeltas</span><span class="p">,</span>
    <span class="n">BoltzmannBackground</span><span class="p">,</span>
    <span class="n">WallParams</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.results</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BoltzmannResults</span><span class="p">,</span>
    <span class="n">HydroResults</span><span class="p">,</span>
    <span class="n">WallGoResults</span><span class="p">,</span>
    <span class="n">ESolutionType</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="EOM">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM">[docs]</a>
<span class="k">class</span> <span class="nc">EOM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that solves the energy-momentum conservation equations and the scalar</span>
<span class="sd">    EOMs to determine the wall velocity.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EOM.__init__">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">boltzmannSolver</span><span class="p">:</span> <span class="n">BoltzmannSolver</span><span class="p">,</span>
        <span class="n">thermodynamics</span><span class="p">:</span> <span class="n">Thermodynamics</span><span class="p">,</span>
        <span class="n">hydrodynamics</span><span class="p">:</span> <span class="n">Hydrodynamics</span><span class="p">,</span>
        <span class="n">grid</span><span class="p">:</span> <span class="n">Grid3Scales</span><span class="p">,</span>
        <span class="n">nbrFields</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">meanFreePathScale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">wallThicknessBounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">wallOffsetBounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">includeOffEq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">forceEnergyConservation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">forceImproveConvergence</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">errTol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">maxIterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">pressRelErrTol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3679</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        boltzmannSolver : BoltzmannSolver</span>
<span class="sd">            BoltzmannSolver instance.</span>
<span class="sd">        thermodynamics : Thermodynamics</span>
<span class="sd">            Thermodynamics object</span>
<span class="sd">        hydrodynamics : Hydrodynamics</span>
<span class="sd">            Hydrodynamics object</span>
<span class="sd">        grid : Grid3Scales</span>
<span class="sd">            Object of the class Grid3Scales.</span>
<span class="sd">        nbrFields : int</span>
<span class="sd">            Number of scalar fields on which the scalar potential depends.</span>
<span class="sd">        meanFreePathScale : float</span>
<span class="sd">            Estimate of the mean free path of the particles in the plasma. Should be</span>
<span class="sd">            expressed in physical units (the units used in EffectivePotential).</span>
<span class="sd">        wallThicknessBounds : tuple</span>
<span class="sd">            Tuple containing the bounds the wall thickness (in units of 1/Tnucl).</span>
<span class="sd">            The solver will never explore outside of this interval.</span>
<span class="sd">        wallOffsetBounds : tuple</span>
<span class="sd">            Tuple containing the bounds the wall offset. The solver will never</span>
<span class="sd">            explore outside of this interval.</span>
<span class="sd">        includeOffEq : bool, optional</span>
<span class="sd">            If False, all the out-of-equilibrium contributions are neglected.</span>
<span class="sd">            The default is False.</span>
<span class="sd">        forceEnergyConservation : bool, optional</span>
<span class="sd">            If True, enforce energy-momentum conservation by solving for the appropriate</span>
<span class="sd">            T and vpl profiles. If false, use fixed T and vpl profiles. Default is True.</span>
<span class="sd">        forceImproveConvergence : bool, optional</span>
<span class="sd">            If True, uses a slower algorithm that improves the convergence when</span>
<span class="sd">            computing the pressure. The improved algorithm is automatically used</span>
<span class="sd">            for detonation. Default is False.</span>
<span class="sd">        errTol : float, optional</span>
<span class="sd">            Absolute error tolerance. The default is 1e-3.</span>
<span class="sd">        maxIterations : int, optional</span>
<span class="sd">            Maximum number of iterations for the convergence of pressure.</span>
<span class="sd">            The default is 10.</span>
<span class="sd">        pressRelErrTol : float, optional</span>
<span class="sd">            Relative tolerance in pressure when finding its root.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boltzmannSolver</span><span class="p">,</span> <span class="n">BoltzmannSolver</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thermodynamics</span><span class="p">,</span> <span class="n">Thermodynamics</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hydrodynamics</span><span class="p">,</span> <span class="n">Hydrodynamics</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">Grid3Scales</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">grid</span> <span class="ow">is</span> <span class="n">boltzmannSolver</span><span class="o">.</span><span class="n">grid</span>
        <span class="p">),</span> <span class="s2">&quot;EOM and BoltzmannSolver must have the same instance of the Grid object.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">boltzmannSolver</span> <span class="o">=</span> <span class="n">boltzmannSolver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span> <span class="o">=</span> <span class="n">nbrFields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanFreePathScale</span> <span class="o">=</span> <span class="n">meanFreePathScale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wallThicknessBounds</span> <span class="o">=</span> <span class="n">wallThicknessBounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wallOffsetBounds</span> <span class="o">=</span> <span class="n">wallOffsetBounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">includeOffEq</span> <span class="o">=</span> <span class="n">includeOffEq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceEnergyConservation</span> <span class="o">=</span> <span class="n">forceEnergyConservation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceImproveConvergence</span> <span class="o">=</span> <span class="n">forceImproveConvergence</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span> <span class="o">=</span> <span class="n">thermodynamics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span> <span class="o">=</span> <span class="n">hydrodynamics</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boltzmannSolver</span><span class="o">.</span><span class="n">offEqParticles</span>

        <span class="c1">## Tolerances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errTol</span> <span class="o">=</span> <span class="n">errTol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxIterations</span> <span class="o">=</span> <span class="n">maxIterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressRelErrTol</span> <span class="o">=</span> <span class="n">pressRelErrTol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressAbsErrTol</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1">## Flag to detect if the temperature profile was found successfully</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">successTemperatureProfile</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">## Flag to detect if we were able to find the pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">successWallPressure</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="EOM.findWallVelocityDeflagrationHybrid">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.findWallVelocityDeflagrationHybrid">[docs]</a>
    <span class="k">def</span> <span class="nf">findWallVelocityDeflagrationHybrid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">wallThicknessIni</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WallGoResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the wall velocity by minimizing the action and solving for the</span>
<span class="sd">        solution with 0 total pressure on the wall. This function only looks for</span>
<span class="sd">        deflagration or hybrid solutions. Returns a velocity of 1 if the pressure</span>
<span class="sd">        peak at vw = vJ is not large enough to stop the wall.</span>
<span class="sd">        For detonation solutions, use solveInterpolation().</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wallThicknessIni : float or None, optional</span>
<span class="sd">            Initial thickness used for all the walls. Should be expressed in physical</span>
<span class="sd">            units (the units used in EffectivePotential). If None, uses 5/Tnucl.</span>
<span class="sd">            Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        WallGoResults</span>
<span class="sd">            WallGoResults object containing the solution of the EOM.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If no initial wall thickness was provided, starts with a reasonable guess</span>
        <span class="k">if</span> <span class="n">wallThicknessIni</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wallThicknessIni</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">Tnucl</span>

        <span class="n">wallParams</span> <span class="o">=</span> <span class="n">WallParams</span><span class="p">(</span>
            <span class="n">widths</span><span class="o">=</span><span class="n">wallThicknessIni</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span><span class="p">),</span>
            <span class="n">offsets</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># In some cases, no deflagration solution can exist below or above some</span>
        <span class="c1"># velocity. That&#39;s why we need to look in the smaller interval [vmin,vmax]</span>
        <span class="c1"># (which is computed by Hydrodynamics) instead of the naive interval [0,vJ].</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">vMin</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">vJ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">fastestDeflag</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">vmax</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">vJ</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">doesPhaseTraceLimitvmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">doesPhaseTraceLimitvmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;\n Warning: vmax is limited by the maximum temperature chosen in</span>
<span class="sd">                the phase tracing. WallGo might be unable to find the wall velocity.</span>
<span class="sd">                Try increasing the maximum temperature! \n&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveWall</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">wallParams</span><span class="p">)</span></div>


<div class="viewcode-block" id="EOM.findWallVelocityDetonation">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.findWallVelocityDetonation">[docs]</a>
    <span class="k">def</span> <span class="nf">findWallVelocityDetonation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vmin</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">vmax</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">wallThicknessIni</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nbrPointsMin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">nbrPointsMax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">overshootProb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">onlySmallest</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">WallGoResults</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the wall velocity of detonation solutions. This is more complicated than</span>
<span class="sd">        for deflagrations or hybrids since the pressure is not necessarily monotonous,</span>
<span class="sd">        so the root cannot be bracketed easily. To bracket it, we start at vmin and</span>
<span class="sd">        increase it until the pressure goes from negative to positive. We then use a</span>
<span class="sd">        normal bracketed root finding algorithm to find the wall velocity. In</span>
<span class="sd">        principles, several solutions can exist. The function can either return a list</span>
<span class="sd">        containing all the solutions or the solution containing the smallest wall</span>
<span class="sd">        velocity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vmin : float</span>
<span class="sd">            Smallest wall velocity probed. Must be between the Jouguet velocity and 1.</span>
<span class="sd">        vmax : float</span>
<span class="sd">            Largest wall velocity probed. Must be between vmin and 1.</span>
<span class="sd">        wallThicknessIni : float | None, optional</span>
<span class="sd">            Initial value of the wall thickness. Should be expressed in physical units</span>
<span class="sd">            (the units used in EffectivePotential). If None, it is set to 5/Tnucl.</span>
<span class="sd">            The default is None.</span>
<span class="sd">        nbrPointsMin : int, optional</span>
<span class="sd">            Minimal number of points to bracket the roots. The default is 5.</span>
<span class="sd">        nbrPointsMax : int, optional</span>
<span class="sd">            Maximal number of points to bracket the roots. The default is 20.</span>
<span class="sd">        overshootProb : float, optional</span>
<span class="sd">            Desired probability of overshooting a root. Must be between 0 and 1. A</span>
<span class="sd">            smaller value will lead to more pressure evaluations</span>
<span class="sd">            (and thus a longer time), but is less likely to miss a root.</span>
<span class="sd">            The default is 0.05.</span>
<span class="sd">        rtol : float, optional</span>
<span class="sd">            Relative tolerance on the pressure. The default is 0.01.</span>
<span class="sd">        onlySmallest : bool, optional</span>
<span class="sd">            If True, returns a list containing only the root with the smallest wall</span>
<span class="sd">            velocity. Otherwise, the list contains all the roots. The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[WallGoResults]</span>
<span class="sd">            List containing the detonation solutions. If no solutions were found,</span>
<span class="sd">            returns a wall velocity of 0  if the pressure is always positive, or 1 if</span>
<span class="sd">            it is negative (runaway wall). If it is positive at vmin and negative at</span>
<span class="sd">            vmax, the outcome is uncertain and would require a time-dependent analysis,</span>
<span class="sd">            so it returns an empty list.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">vJ</span> <span class="o">&lt;</span> <span class="n">vmin</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;EOM error: </span><span class="si">{</span><span class="n">vmin</span><span class="si">=}</span><span class="s2"> must be between &quot;</span> <span class="s2">&quot;vJ and 1&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">vmin</span> <span class="o">&lt;</span> <span class="n">vmax</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;EOM error: </span><span class="si">{</span><span class="n">vmax</span><span class="si">=}</span><span class="s2"> must be between &quot;</span> <span class="s2">&quot;vmin and 1&quot;</span>

        <span class="c1"># If no initial wall thickness was provided, starts with a reasonable guess</span>
        <span class="k">if</span> <span class="n">wallThicknessIni</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wallThicknessIni</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">Tnucl</span>

        <span class="n">wallParams2</span> <span class="o">=</span> <span class="n">WallParams</span><span class="p">(</span>
            <span class="n">widths</span><span class="o">=</span><span class="n">wallThicknessIni</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span><span class="p">),</span>
            <span class="n">offsets</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">vw2</span> <span class="o">=</span> <span class="n">vmin</span>

        <span class="n">wallPressureResults2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallPressure</span><span class="p">(</span><span class="n">vw2</span><span class="p">,</span> <span class="n">wallParams2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">pressure2</span><span class="p">,</span> <span class="n">wallParams</span><span class="p">,</span> <span class="n">boltzmannResults</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wallPressureResults2</span>
        <span class="n">pressureIni</span> <span class="o">=</span> <span class="n">pressure2</span>  <span class="c1"># Only used at the end if no solutions are found</span>

        <span class="n">list2ndDeriv</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">listResults</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Prior on the scale of the 2nd derivative</span>
        <span class="n">std2ndDerivPrior</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">pressure2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span> <span class="o">/</span> <span class="n">vw2</span><span class="o">**</span><span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">vw1</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pressure1</span> <span class="o">=</span> <span class="n">pressure2</span>
        <span class="n">wallPressureResults1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">wallPressureResults2</span><span class="p">)</span>

        <span class="n">stepSizeMin</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nbrPointsMax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stepSizeMax</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nbrPointsMin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">vw2</span> <span class="o">&lt;</span> <span class="n">vmax</span><span class="p">:</span>
            <span class="n">std2ndDeriv</span> <span class="o">=</span> <span class="n">std2ndDerivPrior</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2ndDeriv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">std2ndDeriv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">std2ndDerivPrior</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">list2ndDeriv</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>

            <span class="c1"># Find the next position to explore</span>
            <span class="n">vw3</span> <span class="o">=</span> <span class="n">nextStepDeton</span><span class="p">(</span>
                <span class="n">vw1</span><span class="p">,</span>
                <span class="n">vw2</span><span class="p">,</span>
                <span class="n">pressure1</span><span class="p">,</span>
                <span class="n">pressure2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">std2ndDeriv</span><span class="p">,</span>
                <span class="n">rtol</span><span class="p">,</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vw2</span> <span class="o">+</span> <span class="n">stepSizeMax</span><span class="p">),</span>
                <span class="n">overshootProb</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Increase pos3 if the step size is too small</span>
            <span class="n">vw3</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vw3</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vw2</span> <span class="o">+</span> <span class="n">stepSizeMin</span><span class="p">))</span>

            <span class="c1"># If this is the last point probed and pressure2&gt;0, there is no point in</span>
            <span class="c1"># computing the pressure since no stable solution is possible.</span>
            <span class="k">if</span> <span class="n">vw3</span> <span class="o">==</span> <span class="n">vmax</span> <span class="ow">and</span> <span class="n">pressure2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">wallPressureResults1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">wallPressureResults2</span><span class="p">)</span>

            <span class="c1"># Compute the new pressure</span>
            <span class="n">wallPressureResults2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallPressure</span><span class="p">(</span>
                <span class="n">vw3</span><span class="p">,</span> <span class="n">wallParams</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">boltzmannResults</span>
            <span class="p">)</span>
            <span class="n">pressure3</span><span class="p">,</span> <span class="n">wallParams2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wallPressureResults2</span>

            <span class="c1"># Estimate the 2nd deriv by finite differences and append it to list2nDeriv</span>
            <span class="n">list2ndDeriv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">pressure1</span> <span class="o">*</span> <span class="p">(</span><span class="n">vw2</span> <span class="o">-</span> <span class="n">vw3</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">pressure2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vw1</span> <span class="o">-</span> <span class="n">vw3</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pressure3</span> <span class="o">*</span> <span class="p">(</span><span class="n">vw1</span> <span class="o">-</span> <span class="n">vw2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="p">((</span><span class="n">vw1</span> <span class="o">-</span> <span class="n">vw2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">vw2</span> <span class="o">-</span> <span class="n">vw3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">vw1</span> <span class="o">-</span> <span class="n">vw3</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">pressure3</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">pressure2</span><span class="p">:</span>
                <span class="n">listResults</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">solveWall</span><span class="p">(</span>
                        <span class="n">vw2</span><span class="p">,</span>
                        <span class="n">vw3</span><span class="p">,</span>
                        <span class="n">wallParams2</span><span class="p">,</span>
                        <span class="n">wallPressureResults1</span><span class="p">,</span>
                        <span class="n">wallPressureResults2</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">onlySmallest</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">vw1</span> <span class="o">=</span> <span class="n">vw2</span>
            <span class="n">vw2</span> <span class="o">=</span> <span class="n">vw3</span>
            <span class="n">pressure1</span> <span class="o">=</span> <span class="n">pressure2</span>
            <span class="n">pressure2</span> <span class="o">=</span> <span class="n">pressure3</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listResults</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">WallGoResults</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pressureIni</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">pressure2</span><span class="p">:</span>
                <span class="c1"># The pressure is positive at vJ but negative at 1. The solution should</span>
                <span class="c1"># be a defl/hyb, but time-dependent effects could allow it to be a</span>
                <span class="c1"># runaway.</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setWallVelocities</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="n">ESolutionType</span><span class="o">.</span><span class="n">DEFLAGRATION_OR_RUNAWAY</span><span class="p">,</span>
                    <span class="s2">&quot;The pressure is positive at vJ and negative at 1, but there is no&quot;</span>
                    <span class="s2">&quot; stable detonation solution. The wall could either be a &quot;</span>
                    <span class="s2">&quot;deflagration/hybrid or a runaway.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">pressureIni</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pressure2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Pressure is always positive and is therefore too large to have a</span>
                <span class="c1"># detonation solution.</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setWallVelocities</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="n">ESolutionType</span><span class="o">.</span><span class="n">DEFLAGRATION</span><span class="p">,</span>
                    <span class="s2">&quot;The pressure is too large to have a detonation solution. &quot;</span>
                    <span class="s2">&quot;The solution must be a deflagration or hybrid. Try calling &quot;</span>
                    <span class="s2">&quot;WallGoManager.solveWall() to find it.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Pressure is too small to have a detonation, it is a runaway.</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setWallVelocities</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="n">ESolutionType</span><span class="o">.</span><span class="n">RUNAWAY</span><span class="p">,</span>
                    <span class="s2">&quot;The pressure is too small to have a detonation solution. &quot;</span>
                    <span class="s2">&quot;The solution is a runaway wall.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">results</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">listResults</span></div>


<div class="viewcode-block" id="EOM.solveWall">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.solveWall">[docs]</a>
    <span class="k">def</span> <span class="nf">solveWall</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wallVelocityMin</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">wallVelocityMax</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">wallParamsGuess</span><span class="p">:</span> <span class="n">WallParams</span><span class="p">,</span>
        <span class="n">wallPressureResultsMin</span><span class="p">:</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">[</span>
                <span class="nb">float</span><span class="p">,</span> <span class="n">WallParams</span><span class="p">,</span> <span class="n">BoltzmannResults</span><span class="p">,</span> <span class="n">BoltzmannBackground</span><span class="p">,</span> <span class="n">HydroResults</span>
            <span class="p">]</span>
            <span class="o">|</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wallPressureResultsMax</span><span class="p">:</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">[</span>
                <span class="nb">float</span><span class="p">,</span> <span class="n">WallParams</span><span class="p">,</span> <span class="n">BoltzmannResults</span><span class="p">,</span> <span class="n">BoltzmannBackground</span><span class="p">,</span> <span class="n">HydroResults</span>
            <span class="p">]</span>
            <span class="o">|</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WallGoResults</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves the equation :math:`P_{\rm tot}(\xi_w)=0` for the wall velocity</span>
<span class="sd">        and wall thicknesses/offsets. The solver only looks between wallVelocityMin</span>
<span class="sd">        and wallVelocityMax</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wallVelocityMin : float</span>
<span class="sd">            Lower bound of the bracket in which the root finder will look for a</span>
<span class="sd">            solution. Should satisfy</span>
<span class="sd">            :math:`0&lt;{\rm wallVelocityMin}&lt;{\rm wallVelocityMax}`.</span>
<span class="sd">        wallVelocityMax : float</span>
<span class="sd">            Upper bound of the bracket in which the root finder will look for a</span>
<span class="sd">            solution. Should satisfy</span>
<span class="sd">            :math:`{\rm wallVelocityMin}&lt;{\rm wallVelocityMax}\leq\xi_J`.</span>
<span class="sd">        wallParamsGuess : WallParams</span>
<span class="sd">            Contains a guess of the wall thicknesses and wall offsets.</span>
<span class="sd">        wallPressureResultsMin : tuple or None, optional</span>
<span class="sd">            Tuple containing the results of the self.wallPressure function evaluated</span>
<span class="sd">            at wallVelocityMin. If None, computes it manually. Default is None.</span>
<span class="sd">        wallPressureResultsMax : tuple or None, optional</span>
<span class="sd">            Tuple containing the results of the self.wallPressure function evaluated</span>
<span class="sd">            at wallVelocityMax. If None, computes it manually. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : WallGoResults</span>
<span class="sd">            Data class containing results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">WallGoResults</span><span class="p">()</span>
        <span class="n">results</span><span class="o">.</span><span class="n">hasOutOfEquilibrium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeOffEq</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pressAbsErrTol</span> <span class="o">=</span> <span class="mf">1e-8</span>

        <span class="c1"># Get the pressure at vw = wallVelocityMax</span>
        <span class="k">if</span> <span class="n">wallPressureResultsMax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">pressureMax</span><span class="p">,</span>
                <span class="n">wallParamsMax</span><span class="p">,</span>
                <span class="n">boltzmannResultsMax</span><span class="p">,</span>
                <span class="n">boltzmannBackgroundMax</span><span class="p">,</span>
                <span class="n">hydroResultsMax</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallPressure</span><span class="p">(</span><span class="n">wallVelocityMax</span><span class="p">,</span> <span class="n">wallParamsGuess</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">pressureMax</span><span class="p">,</span>
                <span class="n">wallParamsMax</span><span class="p">,</span>
                <span class="n">boltzmannResultsMax</span><span class="p">,</span>
                <span class="n">boltzmannBackgroundMax</span><span class="p">,</span>
                <span class="n">hydroResultsMax</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">wallPressureResultsMax</span>

        <span class="c1"># also getting the LTE results</span>
        <span class="n">wallVelocityLTE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">findvwLTE</span><span class="p">()</span>

        <span class="c1"># The pressure peak is not enough to stop the wall: no deflagration or</span>
        <span class="c1"># hybrid solution</span>
        <span class="k">if</span> <span class="n">pressureMax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Maximum pressure on wall is negative!&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pressureMax</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">wallParamsMax</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setWallVelocities</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wallVelocityLTE</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setWallParams</span><span class="p">(</span><span class="n">wallParamsMax</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setHydroResults</span><span class="p">(</span><span class="n">hydroResultsMax</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setBoltzmannBackground</span><span class="p">(</span><span class="n">boltzmannBackgroundMax</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setBoltzmannResults</span><span class="p">(</span><span class="n">boltzmannResultsMax</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="n">ESolutionType</span><span class="o">.</span><span class="n">RUNAWAY</span><span class="p">,</span>
                <span class="s2">&quot;The maximum pressure on the wall is negative. &quot;</span>
                <span class="s2">&quot;The solution must be a detonation or a runaway wall.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="c1"># Get the pressure at vw = wallVelocityMin</span>
        <span class="k">if</span> <span class="n">wallPressureResultsMin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">pressureMin</span><span class="p">,</span>
                <span class="n">wallParamsMin</span><span class="p">,</span>
                <span class="n">boltzmannResultsMin</span><span class="p">,</span>
                <span class="n">boltzmannBackgroundMin</span><span class="p">,</span>
                <span class="n">hydroResultsMin</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallPressure</span><span class="p">(</span><span class="n">wallVelocityMin</span><span class="p">,</span> <span class="n">wallParamsGuess</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">pressureMin</span><span class="p">,</span>
                <span class="n">wallParamsMin</span><span class="p">,</span>
                <span class="n">boltzmannResultsMin</span><span class="p">,</span>
                <span class="n">boltzmannBackgroundMin</span><span class="p">,</span>
                <span class="n">hydroResultsMin</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">wallPressureResultsMin</span>

        <span class="k">while</span> <span class="n">pressureMin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If pressureMin is positive, increase wallVelocityMin</span>
            <span class="c1"># until it&#39;s negative.</span>
            <span class="n">wallVelocityMin</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">wallVelocityMin</span> <span class="o">&gt;=</span> <span class="n">wallVelocityMax</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;EOM warning: the pressure at vw = 0 is positive which indicates</span>
<span class="sd">                    the phase transition cannot proceed. Something might be wrong with</span>
<span class="sd">                    your potential.&quot;&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setWallVelocities</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wallVelocityLTE</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setWallParams</span><span class="p">(</span><span class="n">wallParamsMin</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setHydroResults</span><span class="p">(</span><span class="n">hydroResultsMin</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setBoltzmannBackground</span><span class="p">(</span><span class="n">boltzmannBackgroundMin</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setBoltzmannResults</span><span class="p">(</span><span class="n">boltzmannResultsMin</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">ESolutionType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="s2">&quot;The pressure at vw=0 is positive which indicates the PT cannot &quot;</span>
                    <span class="s2">&quot;proceed. Something might be wrong with your potential.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="p">(</span>
                <span class="n">pressureMin</span><span class="p">,</span>
                <span class="n">wallParamsMin</span><span class="p">,</span>
                <span class="n">boltzmannResultsMin</span><span class="p">,</span>
                <span class="n">boltzmannBackgroundMin</span><span class="p">,</span>
                <span class="n">hydroResultsMin</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallPressure</span><span class="p">(</span><span class="n">wallVelocityMin</span><span class="p">,</span> <span class="n">wallParamsGuess</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pressAbsErrTol</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.01</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">errTol</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressRelErrTol</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pressureMin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pressureMax</span><span class="p">))</span>
            <span class="o">/</span> <span class="mi">4</span>
        <span class="p">)</span>

        <span class="c1">## This computes pressure on the wall with a given wall speed and WallParams</span>
        <span class="k">def</span> <span class="nf">pressureWrapper</span><span class="p">(</span><span class="n">vw</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>  <span class="c1"># pylint: disable=invalid-name</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Small optimization here: the root finder below calls this first at the</span>
<span class="sd">            bracket endpoints, for which we already computed the pressure above.</span>
<span class="sd">            So make use of those.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vw</span> <span class="o">-</span> <span class="n">wallVelocityMin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="ow">or</span> <span class="n">vw</span> <span class="o">&lt;</span> <span class="n">wallVelocityMin</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pressureMin</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vw</span> <span class="o">-</span> <span class="n">wallVelocityMax</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="ow">or</span> <span class="n">vw</span> <span class="o">&gt;</span> <span class="n">wallVelocityMax</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pressureMax</span>

            <span class="c1"># Use linear interpolation to get a better first guess for the initial wall</span>
            <span class="c1"># parameters</span>
            <span class="n">fractionVw</span> <span class="o">=</span> <span class="p">(</span><span class="n">vw</span> <span class="o">-</span> <span class="n">wallVelocityMin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wallVelocityMax</span> <span class="o">-</span> <span class="n">wallVelocityMin</span><span class="p">)</span>
            <span class="n">newWallParams</span> <span class="o">=</span> <span class="n">wallParamsMin</span> <span class="o">+</span> <span class="p">(</span><span class="n">wallParamsMax</span> <span class="o">-</span> <span class="n">wallParamsMin</span><span class="p">)</span> <span class="o">*</span> <span class="n">fractionVw</span>
            <span class="n">newBoltzmannResults</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">boltzmannResultsMin</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">boltzmannResultsMax</span> <span class="o">-</span> <span class="n">boltzmannResultsMin</span><span class="p">)</span> <span class="o">*</span> <span class="n">fractionVw</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallPressure</span><span class="p">(</span>
                <span class="n">vw</span><span class="p">,</span> <span class="n">newWallParams</span><span class="p">,</span> <span class="n">boltzmannResultsInput</span><span class="o">=</span><span class="n">newBoltzmannResults</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">optimizeResult</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">root_scalar</span><span class="p">(</span>
            <span class="n">pressureWrapper</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;brentq&quot;</span><span class="p">,</span>
            <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="n">wallVelocityMin</span><span class="p">,</span> <span class="n">wallVelocityMax</span><span class="p">],</span>
            <span class="n">xtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errTol</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">wallVelocity</span> <span class="o">=</span> <span class="n">optimizeResult</span><span class="o">.</span><span class="n">root</span>

        <span class="c1"># Get wall params, and other results</span>
        <span class="n">fractionWallVelocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">wallVelocity</span> <span class="o">-</span> <span class="n">wallVelocityMin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">wallVelocityMax</span> <span class="o">-</span> <span class="n">wallVelocityMin</span>
        <span class="p">)</span>
        <span class="n">newWallParams</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">wallParamsMin</span> <span class="o">+</span> <span class="p">(</span><span class="n">wallParamsMax</span> <span class="o">-</span> <span class="n">wallParamsMin</span><span class="p">)</span> <span class="o">*</span> <span class="n">fractionWallVelocity</span>
        <span class="p">)</span>
        <span class="n">newBoltzmannResults</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">boltzmannResultsMin</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">boltzmannResultsMax</span> <span class="o">-</span> <span class="n">boltzmannResultsMin</span><span class="p">)</span> <span class="o">*</span> <span class="n">fractionWallVelocity</span>
        <span class="p">)</span>
        <span class="p">(</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">wallParams</span><span class="p">,</span>
            <span class="n">boltzmannResults</span><span class="p">,</span>
            <span class="n">boltzmannBackground</span><span class="p">,</span>
            <span class="n">hydroResults</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallPressure</span><span class="p">(</span>
            <span class="n">wallVelocity</span><span class="p">,</span> <span class="n">newWallParams</span><span class="p">,</span> <span class="n">boltzmannResultsInput</span><span class="o">=</span><span class="n">newBoltzmannResults</span>
        <span class="p">)</span>

        <span class="c1"># minimum possible error in the wall speed</span>
        <span class="n">wallVelocityMinError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errTol</span> <span class="o">*</span> <span class="n">optimizeResult</span><span class="o">.</span><span class="n">root</span>

        <span class="c1"># estimating errors from truncation and comparison to finite differences</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeOffEq</span><span class="p">:</span>
            <span class="n">finiteDifferenceBoltzmannResults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBoltzmannFiniteDifference</span><span class="p">()</span>
            <span class="c1"># assuming nonequilibrium errors proportional to deviation from LTE</span>
            <span class="n">wallVelocityDeltaLTE</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wallVelocity</span> <span class="o">-</span> <span class="n">wallVelocityLTE</span><span class="p">)</span>
            <span class="c1"># the truncation error in the spectral method within Boltzmann</span>
            <span class="n">wallVelocityTruncationError</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">boltzmannResults</span><span class="o">.</span><span class="n">truncationError</span> <span class="o">*</span> <span class="n">wallVelocityDeltaLTE</span>
            <span class="p">)</span>
            <span class="c1"># the deviation from the finite difference method within Boltzmann</span>
            <span class="n">delta00</span> <span class="o">=</span> <span class="n">boltzmannResults</span><span class="o">.</span><span class="n">Deltas</span><span class="o">.</span><span class="n">Delta00</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">delta00FD</span> <span class="o">=</span> <span class="n">finiteDifferenceBoltzmannResults</span><span class="o">.</span><span class="n">Deltas</span><span class="o">.</span><span class="n">Delta00</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">errorFD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta00</span> <span class="o">-</span> <span class="n">delta00FD</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta00</span><span class="p">)</span>
            <span class="n">wallVelocityDerivativeError</span> <span class="o">=</span> <span class="n">errorFD</span> <span class="o">*</span> <span class="n">wallVelocityDeltaLTE</span>

            <span class="c1"># if truncation waringin large, raise a warning</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">wallVelocityTruncationError</span> <span class="o">&gt;</span> <span class="n">wallVelocityDerivativeError</span>
                <span class="ow">and</span> <span class="n">wallVelocityTruncationError</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">errTol</span>
            <span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Truncation error large, increase N or M&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

            <span class="c1"># estimating the error by the largest of these</span>
            <span class="n">wallVelocityError</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">wallVelocityMinError</span><span class="p">,</span>
                <span class="n">wallVelocityTruncationError</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finiteDifferenceBoltzmannResults</span> <span class="o">=</span> <span class="n">boltzmannResults</span>
            <span class="n">wallVelocityError</span> <span class="o">=</span> <span class="n">wallVelocityMinError</span>

        <span class="c1"># setting results</span>
        <span class="n">results</span><span class="o">.</span><span class="n">setWallVelocities</span><span class="p">(</span>
            <span class="n">wallVelocity</span><span class="o">=</span><span class="n">wallVelocity</span><span class="p">,</span>
            <span class="n">wallVelocityError</span><span class="o">=</span><span class="n">wallVelocityError</span><span class="p">,</span>
            <span class="n">wallVelocityLTE</span><span class="o">=</span><span class="n">wallVelocityLTE</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">setHydroResults</span><span class="p">(</span><span class="n">hydroResults</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">setWallParams</span><span class="p">(</span><span class="n">wallParams</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">setBoltzmannBackground</span><span class="p">(</span><span class="n">boltzmannBackground</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">setBoltzmannResults</span><span class="p">(</span><span class="n">boltzmannResults</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">setFiniteDifferenceBoltzmannResults</span><span class="p">(</span><span class="n">finiteDifferenceBoltzmannResults</span><span class="p">)</span>

        <span class="c1"># Set the message</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">successTemperatureProfile</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">ESolutionType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="s2">&quot;Could not determine temperature profile.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">results</span><span class="o">.</span><span class="n">temperatureMinus</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">TMinLowT</span>
            <span class="ow">or</span> <span class="n">results</span><span class="o">.</span><span class="n">temperatureMinus</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">TMaxLowT</span>
        <span class="p">):</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">ESolutionType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Tminus=</span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">temperatureMinus</span><span class="si">}</span><span class="s2"> is not in the allowed range &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">TMinLowT</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">TMaxLowT</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">results</span><span class="o">.</span><span class="n">temperaturePlus</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">TMinHighT</span>
            <span class="ow">or</span> <span class="n">results</span><span class="o">.</span><span class="n">temperaturePlus</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">TMaxHighT</span>
        <span class="p">):</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">ESolutionType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Tplus=</span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">temperaturePlus</span><span class="si">}</span><span class="s2"> is not in the allowed range &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">TMinHighT</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">TMaxHighT</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">successWallPressure</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">ESolutionType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="s2">&quot;The pressure for the wall velocity has not converged to sufficient &quot;</span>
                <span class="s2">&quot;accuracy with the given maximum number for iterations.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">optimizeResult</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ESolutionType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">optimizeResult</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallThicknessBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">Tnucl</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wallParams</span><span class="o">.</span><span class="n">offsets</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallOffsetBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                <span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallThicknessBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">Tnucl</span>
            <span class="p">)</span>
            <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wallParams</span><span class="o">.</span><span class="n">offsets</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallOffsetBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">ESolutionType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;At least one of the </span><span class="si">{</span><span class="n">wallParams</span><span class="si">=}</span><span class="s2"> saturates the given bounds. &quot;</span>
                <span class="s2">&quot;The solution is probably inaccurate.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solutionType</span> <span class="o">=</span> <span class="n">ESolutionType</span><span class="o">.</span><span class="n">DEFLAGRATION</span>
            <span class="k">if</span> <span class="n">wallVelocity</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">vJ</span><span class="p">:</span>
                <span class="n">solutionType</span> <span class="o">=</span> <span class="n">ESolutionType</span><span class="o">.</span><span class="n">DETONATION</span>
            <span class="n">results</span><span class="o">.</span><span class="n">setSuccessState</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span> <span class="n">solutionType</span><span class="p">,</span> <span class="s2">&quot;The wall velocity was found successfully.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># return collected results</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="EOM.wallPressure">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.wallPressure">[docs]</a>
    <span class="k">def</span> <span class="nf">wallPressure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wallVelocity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">wallParams</span><span class="p">:</span> <span class="n">WallParams</span><span class="p">,</span>
        <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boltzmannResultsInput</span><span class="p">:</span> <span class="n">BoltzmannResults</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">WallParams</span><span class="p">,</span> <span class="n">BoltzmannResults</span><span class="p">,</span> <span class="n">BoltzmannBackground</span><span class="p">,</span> <span class="n">HydroResults</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the total pressure on the wall by finding the tanh profile</span>
<span class="sd">        that minimizes the action. Can use two different iteration algorithms</span>
<span class="sd">        to find the pressure. If self.forceImproveConvergence=False and</span>
<span class="sd">        wallVelocity&lt;self.hydrodynamics.vJ, uses a fast algorithm that sometimes fails</span>
<span class="sd">        to converge. Otherwise, or if the previous algorithm converges slowly,</span>
<span class="sd">        uses a slower, but more robust algorithm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wallVelocity : float</span>
<span class="sd">            Wall velocity at which the pressure is computed.</span>
<span class="sd">        wallParams : WallParams</span>
<span class="sd">            Contains a guess of the wall thicknesses and wall offsets.</span>
<span class="sd">        atol : float or None, optional</span>
<span class="sd">            Absolute tolerance. If None, uses self.pressAbsErrTol. Default is None.</span>
<span class="sd">        rtol : float or None, optional</span>
<span class="sd">            Relative tolerance. If None, uses self.pressRelErrTol. Default is None.</span>
<span class="sd">        boltzmannResultsInput : BoltzmannResults or None, optional</span>
<span class="sd">            Object of the BoltzmannResults class containing the initial solution</span>
<span class="sd">            of the Boltzmann equation. If None, sets the initial deltaF to 0.</span>
<span class="sd">            Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pressure : float</span>
<span class="sd">            Total pressure on the wall.</span>
<span class="sd">        wallParams : WallParams</span>
<span class="sd">            WallParams object containing the wall thicknesses and wall offsets</span>
<span class="sd">            that minimize the action and solve the EOM. Only returned if</span>
<span class="sd">            returnExtras is True.</span>
<span class="sd">        boltzmannResults : BoltzmannResults</span>
<span class="sd">            BoltzmannResults object containing the solution of the Boltzmann</span>
<span class="sd">            equation. Only returned if returnExtras is True</span>
<span class="sd">        boltzmannBackground : BoltzmannBackground</span>
<span class="sd">            BoltzmannBackground object containing the solution of the hydrodynamic</span>
<span class="sd">            equations and the scalar field profiles. Only returned if returnExtras</span>
<span class="sd">            is True.</span>
<span class="sd">        hydroResults : HydroResults</span>
<span class="sd">            HydroResults object containing the solution obtained from Hydrodynamics.</span>
<span class="sd">            Only returned if returnExtras is True</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">atol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressAbsErrTol</span>
        <span class="k">if</span> <span class="n">rtol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rtol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressRelErrTol</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">successWallPressure</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">improveConvergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceImproveConvergence</span>
        <span class="k">if</span> <span class="n">wallVelocity</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">vJ</span><span class="p">:</span>
            <span class="n">improveConvergence</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;------------- Trying </span><span class="si">{</span><span class="n">wallVelocity</span><span class="si">=:</span><span class="s2">g</span><span class="si">}</span><span class="s2"> -------------&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize the different data class objects and arrays</span>
        <span class="n">zeroPoly</span> <span class="o">=</span> <span class="n">Polynomial</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Array&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">),</span>
            <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Array&quot;</span><span class="p">,</span> <span class="s2">&quot;Cardinal&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">offEquilDeltas</span> <span class="o">=</span> <span class="n">BoltzmannDeltas</span><span class="p">(</span>
            <span class="n">Delta00</span><span class="o">=</span><span class="n">zeroPoly</span><span class="p">,</span>
            <span class="n">Delta02</span><span class="o">=</span><span class="n">zeroPoly</span><span class="p">,</span>
            <span class="n">Delta20</span><span class="o">=</span><span class="n">zeroPoly</span><span class="p">,</span>
            <span class="n">Delta11</span><span class="o">=</span><span class="n">zeroPoly</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">deltaF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">boltzmannResults</span><span class="p">:</span> <span class="n">BoltzmannResults</span>
        <span class="k">if</span> <span class="n">boltzmannResultsInput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">boltzmannResults</span> <span class="o">=</span> <span class="n">BoltzmannResults</span><span class="p">(</span>
                <span class="n">deltaF</span><span class="o">=</span><span class="n">deltaF</span><span class="p">,</span>
                <span class="n">Deltas</span><span class="o">=</span><span class="n">offEquilDeltas</span><span class="p">,</span>
                <span class="n">truncationError</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">linearizationCriterion1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)),</span>
                <span class="n">linearizationCriterion2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">boltzmannResults</span> <span class="o">=</span> <span class="n">boltzmannResultsInput</span>

        <span class="c1"># Find the boundary conditions of the hydrodynamic equations</span>
        <span class="p">(</span>
            <span class="n">c1</span><span class="p">,</span>
            <span class="n">c2</span><span class="p">,</span>
            <span class="n">Tplus</span><span class="p">,</span>
            <span class="n">Tminus</span><span class="p">,</span>
            <span class="n">velocityMid</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">findHydroBoundaries</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
            <span class="n">wallVelocity</span>
        <span class="p">)</span>
        <span class="n">hydroResults</span> <span class="o">=</span> <span class="n">HydroResults</span><span class="p">(</span>
            <span class="n">temperaturePlus</span><span class="o">=</span><span class="n">Tplus</span><span class="p">,</span>
            <span class="n">temperatureMinus</span><span class="o">=</span><span class="n">Tminus</span><span class="p">,</span>
            <span class="n">velocityJouguet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">vJ</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Positions of the phases</span>
        <span class="n">TminusEval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">Tminus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">freeEnergyLow</span><span class="o">.</span><span class="n">interpolationRangeMax</span><span class="p">()),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">freeEnergyLow</span><span class="o">.</span><span class="n">interpolationRangeMin</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">TplusEval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">Tplus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">freeEnergyHigh</span><span class="o">.</span><span class="n">interpolationRangeMax</span><span class="p">()),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">freeEnergyHigh</span><span class="o">.</span><span class="n">interpolationRangeMin</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">vevLowT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">freeEnergyLow</span><span class="p">(</span><span class="n">TminusEval</span><span class="p">)</span><span class="o">.</span><span class="n">fieldsAtMinimum</span>
        <span class="n">vevHighT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">freeEnergyHigh</span><span class="p">(</span><span class="n">TplusEval</span><span class="p">)</span><span class="o">.</span><span class="n">fieldsAtMinimum</span>

        <span class="c1">## Update the grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateGrid</span><span class="p">(</span><span class="n">wallParams</span><span class="p">,</span> <span class="n">velocityMid</span><span class="p">)</span>

        <span class="p">(</span>
            <span class="n">pressure</span><span class="p">,</span>
            <span class="n">wallParams</span><span class="p">,</span>
            <span class="n">boltzmannResults</span><span class="p">,</span>
            <span class="n">boltzmannBackground</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intermediatePressureResults</span><span class="p">(</span>
            <span class="n">wallParams</span><span class="p">,</span>
            <span class="n">vevLowT</span><span class="p">,</span>
            <span class="n">vevHighT</span><span class="p">,</span>
            <span class="n">c1</span><span class="p">,</span>
            <span class="n">c2</span><span class="p">,</span>
            <span class="n">velocityMid</span><span class="p">,</span>
            <span class="n">boltzmannResults</span><span class="p">,</span>
            <span class="n">Tplus</span><span class="p">,</span>
            <span class="n">Tminus</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">temperatureProfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">velocityProfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceEnergyConservation</span><span class="p">:</span>
            <span class="c1"># If conservation of energy and momentum is not enforced, fix the velocity</span>
            <span class="c1"># and temperature to the following profiles, which are the profiles computed</span>
            <span class="c1"># at the first iteration. Otherwise, they will be evaluated at each</span>
            <span class="c1"># iteration.</span>
            <span class="n">temperatureProfile</span> <span class="o">=</span> <span class="n">boltzmannBackground</span><span class="o">.</span><span class="n">temperatureProfile</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">velocityProfile</span> <span class="o">=</span> <span class="n">boltzmannBackground</span><span class="o">.</span><span class="n">velocityProfile</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">pressures</span> <span class="o">=</span> <span class="p">[</span><span class="n">pressure</span><span class="p">]</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The &#39;multiplier&#39; parameter is used to reduce the size of the wall</span>
<span class="sd">        parameters updates during the iteration procedure. The next iteration</span>
<span class="sd">        will use multiplier*newWallParams+(1-multiplier)*oldWallParams.</span>
<span class="sd">        Can be used when the iterations do not converge, even close to the</span>
<span class="sd">        true solution. For small enough values, we should always be able to converge.</span>
<span class="sd">        The value will be reduced if the algorithm doesn&#39;t converge.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;pressure&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;error&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;errorSolver&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;errTol&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;cautious&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;multiplier&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">improveConvergence</span><span class="p">:</span>
                <span class="c1"># Use the improved algorithm (which converges better but slowly)</span>
                <span class="p">(</span>
                    <span class="n">pressure</span><span class="p">,</span>
                    <span class="n">wallParams</span><span class="p">,</span>
                    <span class="n">boltzmannResults</span><span class="p">,</span>
                    <span class="n">boltzmannBackground</span><span class="p">,</span>
                    <span class="n">errorSolver</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNextPressure</span><span class="p">(</span>
                    <span class="n">pressure</span><span class="p">,</span>
                    <span class="n">wallParams</span><span class="p">,</span>
                    <span class="n">vevLowT</span><span class="p">,</span>
                    <span class="n">vevHighT</span><span class="p">,</span>
                    <span class="n">c1</span><span class="p">,</span>
                    <span class="n">c2</span><span class="p">,</span>
                    <span class="n">velocityMid</span><span class="p">,</span>
                    <span class="n">boltzmannResults</span><span class="p">,</span>
                    <span class="n">Tplus</span><span class="p">,</span>
                    <span class="n">Tminus</span><span class="p">,</span>
                    <span class="n">temperatureProfile</span><span class="o">=</span><span class="n">temperatureProfile</span><span class="p">,</span>
                    <span class="n">velocityProfile</span><span class="o">=</span><span class="n">velocityProfile</span><span class="p">,</span>
                    <span class="n">multiplier</span><span class="o">=</span><span class="n">multiplier</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">pressure</span><span class="p">,</span>
                    <span class="n">wallParams</span><span class="p">,</span>
                    <span class="n">boltzmannResults</span><span class="p">,</span>
                    <span class="n">boltzmannBackground</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intermediatePressureResults</span><span class="p">(</span>
                    <span class="n">wallParams</span><span class="p">,</span>
                    <span class="n">vevLowT</span><span class="p">,</span>
                    <span class="n">vevHighT</span><span class="p">,</span>
                    <span class="n">c1</span><span class="p">,</span>
                    <span class="n">c2</span><span class="p">,</span>
                    <span class="n">velocityMid</span><span class="p">,</span>
                    <span class="n">boltzmannResults</span><span class="p">,</span>
                    <span class="n">Tplus</span><span class="p">,</span>
                    <span class="n">Tminus</span><span class="p">,</span>
                    <span class="n">temperatureProfileInput</span><span class="o">=</span><span class="n">temperatureProfile</span><span class="p">,</span>
                    <span class="n">velocityProfileInput</span><span class="o">=</span><span class="n">velocityProfile</span><span class="p">,</span>
                    <span class="n">multiplier</span><span class="o">=</span><span class="n">multiplier</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">errorSolver</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pressures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>

            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">errTol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rtol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pressure</span><span class="p">),</span> <span class="n">atol</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pressure</span><span class="si">:</span><span class="s2">&gt;12g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">&gt;12g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">errorSolver</span><span class="si">:</span><span class="s2">&gt;12g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">errTol</span><span class="si">:</span><span class="s2">&gt;12g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">improveConvergence</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">multiplier</span><span class="si">:</span><span class="s2">&gt;12g</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">errTol</span> <span class="ow">or</span> <span class="p">(</span><span class="n">errorSolver</span> <span class="o">&lt;</span> <span class="n">errTol</span> <span class="ow">and</span> <span class="n">improveConvergence</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Even if two consecutive call to _getNextPressure() give similar</span>
<span class="sd">                pressures, it is possible that the internal calls made to</span>
<span class="sd">                _intermediatePressureResults() do not converge. This is measured</span>
<span class="sd">                by &#39;errorSolver&#39;. If _getNextPressure() converges but</span>
<span class="sd">                _intermediatePressureResults() doesn&#39;t, &#39;multiplier&#39; is probably too</span>
<span class="sd">                large. We therefore continue the iteration procedure with a smaller</span>
<span class="sd">                value of &#39;multiplier&#39;.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="n">errorSolver</span> <span class="o">&gt;</span> <span class="n">errTol</span><span class="p">:</span>
                    <span class="n">multiplier</span> <span class="o">/=</span> <span class="mf">2.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxIterations</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Pressure for a wall velocity has not converged to &quot;</span>
                    <span class="s2">&quot;sufficient accuracy with the given maximum number &quot;</span>
                    <span class="s2">&quot;for iterations.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># If it has not converged, returns the mean of the last 4 iterations</span>
                <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">successWallPressure</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># If the pressure oscillates between 2 values, decrease the multiplier</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">errTol</span>
                    <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">errTol</span>
                <span class="p">):</span>
                    <span class="n">multiplier</span> <span class="o">/=</span> <span class="mf">2.0</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">multiplier</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">multiplier</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">**</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">:</span>
                    <span class="c1"># If the error decreases too slowly, use the improved algorithm</span>
                    <span class="n">improveConvergence</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final </span><span class="si">{</span><span class="n">pressure</span><span class="si">=:</span><span class="s2">g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final </span><span class="si">{</span><span class="n">wallParams</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pressure</span><span class="p">,</span>
            <span class="n">wallParams</span><span class="p">,</span>
            <span class="n">boltzmannResults</span><span class="p">,</span>
            <span class="n">boltzmannBackground</span><span class="p">,</span>
            <span class="n">hydroResults</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_getNextPressure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pressure1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">wallParams1</span><span class="p">:</span> <span class="n">WallParams</span><span class="p">,</span>
        <span class="n">vevLowT</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">vevHighT</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">c1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">c2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">velocityMid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">boltzmannResults1</span><span class="p">:</span> <span class="n">BoltzmannResults</span><span class="p">,</span>
        <span class="n">Tplus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">Tminus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">temperatureProfile</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">velocityProfile</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the next iteration to solve the EOM and Boltzmann equation.</span>
<span class="sd">        First computes the pressure twice, updating the wall parameters and</span>
<span class="sd">        Boltzmann results each time. If the iterations overshot the true solution</span>
<span class="sd">        (the two pressure updates go in opposite directions), uses linear</span>
<span class="sd">        interpolation to find a better estimate of the true solution. This function is</span>
<span class="sd">        called only when improveConvergence=True in wallPressure().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span>
            <span class="n">pressure2</span><span class="p">,</span>
            <span class="n">wallParams2</span><span class="p">,</span>
            <span class="n">boltzmannResults2</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intermediatePressureResults</span><span class="p">(</span>
            <span class="n">wallParams1</span><span class="p">,</span>
            <span class="n">vevLowT</span><span class="p">,</span>
            <span class="n">vevHighT</span><span class="p">,</span>
            <span class="n">c1</span><span class="p">,</span>
            <span class="n">c2</span><span class="p">,</span>
            <span class="n">velocityMid</span><span class="p">,</span>
            <span class="n">boltzmannResults1</span><span class="p">,</span>
            <span class="n">Tplus</span><span class="p">,</span>
            <span class="n">Tminus</span><span class="p">,</span>
            <span class="n">temperatureProfile</span><span class="p">,</span>
            <span class="n">velocityProfile</span><span class="p">,</span>
            <span class="n">multiplier</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="p">(</span>
            <span class="n">pressure3</span><span class="p">,</span>
            <span class="n">wallParams3</span><span class="p">,</span>
            <span class="n">boltzmannResults3</span><span class="p">,</span>
            <span class="n">boltzmannBackground3</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intermediatePressureResults</span><span class="p">(</span>
            <span class="n">wallParams2</span><span class="p">,</span>
            <span class="n">vevLowT</span><span class="p">,</span>
            <span class="n">vevHighT</span><span class="p">,</span>
            <span class="n">c1</span><span class="p">,</span>
            <span class="n">c2</span><span class="p">,</span>
            <span class="n">velocityMid</span><span class="p">,</span>
            <span class="n">boltzmannResults2</span><span class="p">,</span>
            <span class="n">Tplus</span><span class="p">,</span>
            <span class="n">Tminus</span><span class="p">,</span>
            <span class="n">temperatureProfile</span><span class="p">,</span>
            <span class="n">velocityProfile</span><span class="p">,</span>
            <span class="n">multiplier</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1">## If the last iteration does not overshoot the real pressure (the two</span>
        <span class="c1">## last update go in the same direction), returns the last iteration.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pressure3</span> <span class="o">-</span> <span class="n">pressure2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pressure2</span> <span class="o">-</span> <span class="n">pressure1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pressure3</span> <span class="o">-</span> <span class="n">pressure2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pressure3</span><span class="p">,</span> <span class="n">wallParams3</span><span class="p">,</span> <span class="n">boltzmannResults3</span><span class="p">,</span> <span class="n">boltzmannBackground3</span><span class="p">,</span> <span class="n">err</span>

        <span class="c1">## If the last iteration overshot, uses linear interpolation to find a</span>
        <span class="c1">## better estimate of the true solution.</span>
        <span class="n">interpPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressure1</span> <span class="o">-</span> <span class="n">pressure2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pressure1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pressure2</span> <span class="o">+</span> <span class="n">pressure3</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">pressure4</span><span class="p">,</span>
            <span class="n">wallParams4</span><span class="p">,</span>
            <span class="n">boltzmannResults4</span><span class="p">,</span>
            <span class="n">boltzmannBackground4</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intermediatePressureResults</span><span class="p">(</span>
            <span class="n">wallParams1</span> <span class="o">+</span> <span class="p">(</span><span class="n">wallParams2</span> <span class="o">-</span> <span class="n">wallParams1</span><span class="p">)</span> <span class="o">*</span> <span class="n">interpPoint</span><span class="p">,</span>
            <span class="n">vevLowT</span><span class="p">,</span>
            <span class="n">vevHighT</span><span class="p">,</span>
            <span class="n">c1</span><span class="p">,</span>
            <span class="n">c2</span><span class="p">,</span>
            <span class="n">velocityMid</span><span class="p">,</span>
            <span class="n">boltzmannResults1</span> <span class="o">+</span> <span class="p">(</span><span class="n">boltzmannResults2</span> <span class="o">-</span> <span class="n">boltzmannResults1</span><span class="p">)</span> <span class="o">*</span> <span class="n">interpPoint</span><span class="p">,</span>
            <span class="n">Tplus</span><span class="p">,</span>
            <span class="n">Tminus</span><span class="p">,</span>
            <span class="n">temperatureProfile</span><span class="p">,</span>
            <span class="n">velocityProfile</span><span class="p">,</span>
            <span class="n">multiplier</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pressure4</span> <span class="o">-</span> <span class="n">pressure2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pressure4</span><span class="p">,</span> <span class="n">wallParams4</span><span class="p">,</span> <span class="n">boltzmannResults4</span><span class="p">,</span> <span class="n">boltzmannBackground4</span><span class="p">,</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_intermediatePressureResults</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wallParams</span><span class="p">:</span> <span class="n">WallParams</span><span class="p">,</span>
        <span class="n">vevLowT</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">vevHighT</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">c1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">c2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">velocityMid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">boltzmannResults</span><span class="p">:</span> <span class="n">BoltzmannResults</span><span class="p">,</span>
        <span class="n">Tplus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">Tminus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">temperatureProfileInput</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">velocityProfileInput</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">WallParams</span><span class="p">,</span> <span class="n">BoltzmannResults</span><span class="p">,</span> <span class="n">BoltzmannBackground</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs one step of the iteration procedure to update the pressure,</span>
<span class="sd">        wall parameters and Boltzmann solution. This is done by first solving</span>
<span class="sd">        the Boltzmann equation and then minimizing the action to solve the EOM.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallThicknessBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">Tnucl</span>
            <span class="p">),</span>
            <span class="mf">1.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallThicknessBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">Tnucl</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">wallParams</span><span class="o">.</span><span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">wallParams</span><span class="o">.</span><span class="n">offsets</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallOffsetBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="mf">1.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallOffsetBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1">## here dfieldsdz are z-derivatives of the fields</span>
        <span class="n">fields</span><span class="p">,</span> <span class="n">dfieldsdz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallProfile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xiValues</span><span class="p">,</span> <span class="n">vevLowT</span><span class="p">,</span> <span class="n">vevHighT</span><span class="p">,</span> <span class="n">wallParams</span>
        <span class="p">)</span>

        <span class="n">temperatureProfile</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="n">velocityProfile</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="k">if</span> <span class="n">temperatureProfileInput</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">velocityProfileInput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temperatureProfile</span><span class="p">,</span> <span class="n">velocityProfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findPlasmaProfile</span><span class="p">(</span>
                <span class="n">c1</span><span class="p">,</span>
                <span class="n">c2</span><span class="p">,</span>
                <span class="n">velocityMid</span><span class="p">,</span>
                <span class="n">fields</span><span class="p">,</span>
                <span class="n">dfieldsdz</span><span class="p">,</span>
                <span class="n">boltzmannResults</span><span class="o">.</span><span class="n">Deltas</span><span class="p">,</span>
                <span class="n">Tplus</span><span class="p">,</span>
                <span class="n">Tminus</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temperatureProfile</span> <span class="o">=</span> <span class="n">temperatureProfileInput</span>
            <span class="n">velocityProfile</span> <span class="o">=</span> <span class="n">velocityProfileInput</span>

        <span class="c1">## Prepare a new background for Boltzmann</span>
        <span class="n">TWithEndpoints</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Tminus</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temperatureProfile</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Tplus</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="n">fieldsWithEndpoints</span><span class="p">:</span> <span class="n">Fields</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">vevLowT</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">vevHighT</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">overFieldPoints</span>
        <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">Fields</span><span class="p">)</span>
        <span class="n">vWithEndpoints</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">velocityProfile</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">velocityProfile</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">velocityProfile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">boltzmannBackground</span> <span class="o">=</span> <span class="n">BoltzmannBackground</span><span class="p">(</span>
            <span class="n">velocityMid</span><span class="p">,</span>
            <span class="n">vWithEndpoints</span><span class="p">,</span>
            <span class="n">fieldsWithEndpoints</span><span class="p">,</span>
            <span class="n">TWithEndpoints</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeOffEq</span><span class="p">:</span>
            <span class="c1">## ---- Solve Boltzmann equation to get out-of-equilibrium contributions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boltzmannSolver</span><span class="o">.</span><span class="n">setBackground</span><span class="p">(</span><span class="n">boltzmannBackground</span><span class="p">)</span>
            <span class="n">boltzmannResults</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">boltzmannSolver</span><span class="o">.</span><span class="n">getDeltas</span><span class="p">()</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">*</span> <span class="n">boltzmannResults</span>
            <span class="p">)</span>

        <span class="c1"># Need to solve wallWidth and wallOffset. For this, put wallParams in a 1D array</span>
        <span class="c1"># NOT including the first offset which we keep at 0.</span>
        <span class="n">wallArray</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span><span class="p">,</span> <span class="n">wallParams</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="p">)</span>  <span class="c1">## should work even if offsets is just 1 element</span>

        <span class="c1">## first width, then offset</span>
        <span class="n">lowerBounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span> <span class="o">*</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wallThicknessBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">Tnucl</span><span class="p">],</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wallOffsetBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">upperBounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span> <span class="o">*</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wallThicknessBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">Tnucl</span><span class="p">],</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wallOffsetBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">Bounds</span><span class="p">(</span><span class="n">lb</span><span class="o">=</span><span class="n">lowerBounds</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">upperBounds</span><span class="p">)</span>

        <span class="c1">## And then a wrapper that puts the inputs back in WallParams</span>
        <span class="k">def</span> <span class="nf">actionWrapper</span><span class="p">(</span>
            <span class="n">wallArray</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Fields</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span> <span class="o">|</span> <span class="n">Polynomial</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toWallParams</span><span class="p">(</span><span class="n">wallArray</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="n">Delta00</span> <span class="o">=</span> <span class="n">boltzmannResults</span><span class="o">.</span><span class="n">Deltas</span><span class="o">.</span><span class="n">Delta00</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
            <span class="n">actionWrapper</span><span class="p">,</span>
            <span class="n">wallArray</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">vevLowT</span><span class="p">,</span> <span class="n">vevHighT</span><span class="p">,</span> <span class="n">temperatureProfile</span><span class="p">,</span> <span class="n">Delta00</span><span class="p">),</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Nelder-Mead&quot;</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1">## Put the resulting width, offset back in WallParams format</span>
        <span class="n">wallParams</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toWallParams</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">*</span> <span class="n">wallParams</span>
        <span class="p">)</span>

        <span class="n">fields</span><span class="p">,</span> <span class="n">dPhidz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallProfile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xiValues</span><span class="p">,</span> <span class="n">vevLowT</span><span class="p">,</span> <span class="n">vevHighT</span><span class="p">,</span> <span class="n">wallParams</span>
        <span class="p">)</span>
        <span class="n">dVdPhi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">effectivePotential</span><span class="o">.</span><span class="n">derivField</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">temperatureProfile</span><span class="p">)</span>

        <span class="c1"># Out-of-equilibrium term of the EOM</span>
        <span class="n">dVout</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">particle</span><span class="o">.</span><span class="n">totalDOFs</span>
                    <span class="o">*</span> <span class="n">particle</span><span class="o">.</span><span class="n">msqDerivative</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">Delta00</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="c1">## EOM for field i is d^2 phi_i + dVfull == 0, the latter term is dVdPhi + dVout</span>
        <span class="n">dVfull</span><span class="p">:</span> <span class="n">Fields</span> <span class="o">=</span> <span class="n">dVdPhi</span> <span class="o">+</span> <span class="n">dVout</span>

        <span class="n">dVdz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dVfull</span> <span class="o">*</span> <span class="n">dPhidz</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create a Polynomial object to represent dVdz. Will be used to integrate it.</span>
        <span class="n">eomPoly</span> <span class="o">=</span> <span class="n">Polynomial</span><span class="p">(</span><span class="n">dVdz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>

        <span class="n">dzdchi</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getCompactificationDerivatives</span><span class="p">()</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="n">eomPoly</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">weight</span><span class="o">=-</span><span class="n">dzdchi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">wallParams</span><span class="p">,</span> <span class="n">boltzmannResults</span><span class="p">,</span> <span class="n">boltzmannBackground</span>

    <span class="k">def</span> <span class="nf">_toWallParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wallArray</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WallParams</span><span class="p">:</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span> <span class="n">wallArray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span> <span class="p">:])</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">WallParams</span><span class="p">(</span><span class="n">widths</span><span class="o">=</span><span class="n">wallArray</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbrFields</span><span class="p">],</span> <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_updateGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wallParams</span><span class="p">:</span> <span class="n">WallParams</span><span class="p">,</span> <span class="n">velocityMid</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the grid parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wallParams : WallParams</span>
<span class="sd">            Wall parameters to match.</span>
<span class="sd">        velocityMid : float</span>
<span class="sd">            Plasma velocity at xi=0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">widths</span> <span class="o">=</span> <span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">wallParams</span><span class="o">.</span><span class="n">offsets</span>
        <span class="c1">## Distance between the right and left edges of the walls at the boundaries</span>
        <span class="n">wallThicknessGrid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">)</span> <span class="o">*</span> <span class="n">widths</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">)</span> <span class="o">*</span> <span class="n">widths</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1">## Center between these two edges</span>
        <span class="c1">## The source and pressure are proportional to d(m^2)/dz, which peaks at</span>
        <span class="c1">## -wallThicknessGrid*np.log(2)/2. This is why we substract this value.</span>
        <span class="n">wallCenterGrid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">)</span> <span class="o">*</span> <span class="n">widths</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">)</span> <span class="o">*</span> <span class="n">widths</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">wallThicknessGrid</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">gammaWall</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">velocityMid</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; The length of the tail inside typically scales like gamma, while the one</span>
<span class="sd">        outside like 1/gamma. We take the max because the tail lengths must be larger</span>
<span class="sd">        than wallThicknessGrid*(1+2*smoothing)/ratioPointsWall &quot;&quot;&quot;</span>
        <span class="n">tailInside</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanFreePathScale</span> <span class="o">*</span> <span class="n">gammaWall</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeOffEq</span><span class="p">,</span>
            <span class="n">wallThicknessGrid</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">2.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">smoothing</span><span class="p">)</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ratioPointsWall</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">tailOutside</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanFreePathScale</span> <span class="o">/</span> <span class="n">gammaWall</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeOffEq</span><span class="p">,</span>
            <span class="n">wallThicknessGrid</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">2.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">smoothing</span><span class="p">)</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ratioPointsWall</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">changePositionFalloffScale</span><span class="p">(</span>
            <span class="n">tailInside</span><span class="p">,</span> <span class="n">tailOutside</span><span class="p">,</span> <span class="n">wallThicknessGrid</span><span class="p">,</span> <span class="n">wallCenterGrid</span>
        <span class="p">)</span>

<div class="viewcode-block" id="EOM.action">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.action">[docs]</a>
    <span class="k">def</span> <span class="nf">action</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wallParams</span><span class="p">:</span> <span class="n">WallParams</span><span class="p">,</span>
        <span class="n">vevLowT</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">vevHighT</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">temperatureProfile</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">offEquilDelta00</span><span class="p">:</span> <span class="n">Polynomial</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the action by using gaussian quadratrure to integrate the Lagrangian.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wallParams : WallParams</span>
<span class="sd">            WallParams object.</span>
<span class="sd">        vevLowT : Fields</span>
<span class="sd">            Field values in the low-T phase.</span>
<span class="sd">        vevHighT : Fields</span>
<span class="sd">            Field values in the high-T phase.</span>
<span class="sd">        temperatureProfile : ndarray</span>
<span class="sd">            Temperature profile on the grid.</span>
<span class="sd">        offEquilDelta00 : Polynomial</span>
<span class="sd">            Off-equilibrium function Delta00.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        action : float</span>
<span class="sd">            Action spent by the scalar field configuration.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">wallWidths</span> <span class="o">=</span> <span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span>

        <span class="c1"># Computing the field profiles</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallProfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xiValues</span><span class="p">,</span> <span class="n">vevLowT</span><span class="p">,</span> <span class="n">vevHighT</span><span class="p">,</span> <span class="n">wallParams</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Computing the potential</span>
        <span class="n">potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">effectivePotential</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">temperatureProfile</span><span class="p">)</span>

        <span class="c1"># Computing the out-of-equilibrium term of the action</span>
        <span class="n">potentialOut</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">particle</span><span class="o">.</span><span class="n">totalDOFs</span>
                    <span class="o">*</span> <span class="n">particle</span><span class="o">.</span><span class="n">msqVacuum</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">offEquilDelta00</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="c1"># Values of the potential at the boundaries</span>
        <span class="n">potentialLowT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">effectivePotential</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="n">vevLowT</span><span class="p">,</span> <span class="n">temperatureProfile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">potentialHighT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">effectivePotential</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="n">vevHighT</span><span class="p">,</span> <span class="n">temperatureProfile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">potentialRef</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">potentialLowT</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">potentialHighT</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Integrating the potential to get the action</span>
        <span class="c1"># We substract Vref (which has no effect on the EOM) to make the integral finite</span>
        <span class="n">potentialPoly</span> <span class="o">=</span> <span class="n">Polynomial</span><span class="p">(</span><span class="n">potential</span> <span class="o">+</span> <span class="n">potentialOut</span> <span class="o">-</span> <span class="n">potentialRef</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">dzdchi</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getCompactificationDerivatives</span><span class="p">()</span>

        <span class="c1"># Potential energy part of the action</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">potentialPoly</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">dzdchi</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="c1"># Kinetic part of the action</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
            <span class="p">(</span><span class="n">vevHighT</span> <span class="o">-</span> <span class="n">vevLowT</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">wallWidths</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">U</span> <span class="o">+</span> <span class="n">K</span><span class="p">)</span></div>


<div class="viewcode-block" id="EOM.wallProfile">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.wallProfile">[docs]</a>
    <span class="k">def</span> <span class="nf">wallProfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">vevLowT</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">vevHighT</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">wallParams</span><span class="p">:</span> <span class="n">WallParams</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Fields</span><span class="p">,</span> <span class="n">Fields</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the scalar field profile and its derivative with respect to</span>
<span class="sd">        the position in the wall.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        z : ndarray</span>
<span class="sd">            Position grid on which to compute the scalar field profile.</span>
<span class="sd">        vevLowT : Fields</span>
<span class="sd">            Scalar field VEVs in the low-T phase.</span>
<span class="sd">        vevHighT : Fields</span>
<span class="sd">            Scalar field VEVs in the high-T phase.</span>
<span class="sd">        wallParams : WallParams</span>
<span class="sd">            WallParams object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fields : Fields</span>
<span class="sd">            Scalar field profile.</span>
<span class="sd">        dPhidz : Fields</span>
<span class="sd">            Derivative with respect to the position of the scalar field profile.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">zL</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## Broadcast mess needed</span>
            <span class="n">zL</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">vevLowT</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">vevHighT</span> <span class="o">-</span> <span class="n">vevLowT</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">zL</span> <span class="o">+</span> <span class="n">wallParams</span><span class="o">.</span><span class="n">offsets</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dPhidz</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">0.5</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">vevHighT</span> <span class="o">-</span> <span class="n">vevLowT</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">wallParams</span><span class="o">.</span><span class="n">widths</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cosh</span><span class="p">(</span><span class="n">zL</span> <span class="o">+</span> <span class="n">wallParams</span><span class="o">.</span><span class="n">offsets</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">Fields</span><span class="o">.</span><span class="n">castFromNumpy</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="n">Fields</span><span class="o">.</span><span class="n">castFromNumpy</span><span class="p">(</span><span class="n">dPhidz</span><span class="p">)</span></div>


<div class="viewcode-block" id="EOM.findPlasmaProfile">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.findPlasmaProfile">[docs]</a>
    <span class="k">def</span> <span class="nf">findPlasmaProfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">c1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">c2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">velocityMid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">dPhidz</span><span class="p">:</span> <span class="n">Fields</span><span class="p">,</span>
        <span class="n">offEquilDeltas</span><span class="p">:</span> <span class="n">BoltzmannDeltas</span><span class="p">,</span>
        <span class="n">Tplus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">Tminus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves Eq. (20) of arXiv:2204.13120v1 globally. If no solution, the minimum of</span>
<span class="sd">        LHS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c1 : float</span>
<span class="sd">            Value of the :math:`T^{30}` component of the energy-momentum tensor.</span>
<span class="sd">        c2 : float</span>
<span class="sd">            Value of the :math:`T^{33}` component of the energy-momentum tensor.</span>
<span class="sd">        velocityMid : float</span>
<span class="sd">            Midpoint of plasma velocity in the wall frame, :math:`(v_+ + v_-)/2`.</span>
<span class="sd">        fields : Fields</span>
<span class="sd">            Scalar field profiles.</span>
<span class="sd">        dPhidz : Fields</span>
<span class="sd">            Derivative with respect to the position of the scalar field profiles.</span>
<span class="sd">        offEquilDeltas : BoltzmannDeltas</span>
<span class="sd">            BoltzmannDeltas object containing the off-equilibrium Delta functions</span>
<span class="sd">        Tplus : float</span>
<span class="sd">            Plasma temperature in front of the wall.</span>
<span class="sd">        Tminus : float</span>
<span class="sd">            Plasma temperature behind the wall.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        temperatureProfile : array-like</span>
<span class="sd">            Temperature profile in the wall.</span>
<span class="sd">        velocityProfile : array-like</span>
<span class="sd">            Plasma velocity profile in the wall.</span>
<span class="sd">        success : bool</span>
<span class="sd">            Whether or not the temperature profile was found successfully.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temperatureProfile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xiValues</span><span class="p">))</span>
        <span class="n">velocityProfile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xiValues</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">successTemperatureProfile</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xiValues</span><span class="p">)):</span>
            <span class="n">T</span><span class="p">,</span> <span class="n">vPlasma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findPlasmaProfilePoint</span><span class="p">(</span>
                <span class="n">index</span><span class="p">,</span>
                <span class="n">c1</span><span class="p">,</span>
                <span class="n">c2</span><span class="p">,</span>
                <span class="n">velocityMid</span><span class="p">,</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">getFieldPoint</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
                <span class="n">dPhidz</span><span class="o">.</span><span class="n">getFieldPoint</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
                <span class="n">offEquilDeltas</span><span class="p">,</span>
                <span class="n">Tplus</span><span class="p">,</span>
                <span class="n">Tminus</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">temperatureProfile</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
                <span class="n">velocityProfile</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">vPlasma</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## If no solution was found, use the last point</span>
                <span class="n">temperatureProfile</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperatureProfile</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">velocityProfile</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">velocityProfile</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">successTemperatureProfile</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">temperatureProfile</span><span class="p">,</span> <span class="n">velocityProfile</span></div>


<div class="viewcode-block" id="EOM.findPlasmaProfilePoint">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.findPlasmaProfilePoint">[docs]</a>
    <span class="k">def</span> <span class="nf">findPlasmaProfilePoint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">c1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">c2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">velocityMid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">FieldPoint</span><span class="p">,</span>
        <span class="n">dPhidz</span><span class="p">:</span> <span class="n">FieldPoint</span><span class="p">,</span>
        <span class="n">offEquilDeltas</span><span class="p">:</span> <span class="n">BoltzmannDeltas</span><span class="p">,</span>
        <span class="n">Tplus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">Tminus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves Eq. (20) of arXiv:2204.13120v1 locally. If no solution,</span>
<span class="sd">        the minimum of LHS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index of the grid point on which to find the plasma profile.</span>
<span class="sd">        c1 : float</span>
<span class="sd">            Value of the :math:`T^{30}` component of the energy-momentum tensor.</span>
<span class="sd">        c2 : float</span>
<span class="sd">            Value of the :math:`T^{33}` component of the energy-momentum tensor.</span>
<span class="sd">        velocityMid : float</span>
<span class="sd">            Midpoint of plasma velocity in the wall frame, :math:`(v_+ + v_-)/2`.</span>
<span class="sd">        fields : FieldPoint</span>
<span class="sd">            Scalar field profile.</span>
<span class="sd">        dPhidz : FieldPoint</span>
<span class="sd">            Derivative with respect to the position of the scalar field profile.</span>
<span class="sd">        offEquilDeltas : BoltzmannDeltas</span>
<span class="sd">            BoltzmannDeltas object containing the off-equilibrium Delta functions</span>
<span class="sd">        Tplus : float</span>
<span class="sd">            Plasma temperature in front of the wall.</span>
<span class="sd">        Tminus : float</span>
<span class="sd">            Plasma temperature behind the wall.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        T : float</span>
<span class="sd">            Temperature at the point grid.xiValues[index].</span>
<span class="sd">        vPlasma : float</span>
<span class="sd">            Plasma velocity at the point grid.xiValues[index].</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Computing the out-of-equilibrium part of the energy-momentum tensor</span>
        <span class="n">Tout30</span><span class="p">,</span> <span class="n">Tout33</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaToTmunu</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">velocityMid</span><span class="p">,</span> <span class="n">offEquilDeltas</span><span class="p">)</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">Tout30</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">Tout33</span>  <span class="c1"># pylint: disable=invalid-name</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function we want to solve look in general like a parabola. In particular,</span>
<span class="sd">        it has two solutions, one deflagration and one detonation. To solve it,</span>
<span class="sd">        we first find the parabola&#39;s minimum, and then select the desired </span>
<span class="sd">        solution on either side of the minimum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">minRes</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">T</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperatureProfileEqLHS</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">dPhidz</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">),</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Bounded&quot;</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">Tplus</span><span class="p">,</span> <span class="n">Tminus</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="c1"># If the minimum is positive, there are no roots and we return the</span>
        <span class="c1"># minimum&#39;s position</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperatureProfileEqLHS</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">dPhidz</span><span class="p">,</span> <span class="n">minRes</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">minRes</span><span class="o">.</span><span class="n">x</span>
            <span class="n">vPlasma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plasmaVelocity</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">vPlasma</span>

        <span class="c1"># Bracketing the root</span>
        <span class="n">tempAtMinimum</span> <span class="o">=</span> <span class="n">minRes</span><span class="o">.</span><span class="n">x</span>
        <span class="n">TMultiplier</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Tplus</span> <span class="o">/</span> <span class="n">tempAtMinimum</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="c1"># If this is a detonation solution, finds a solution below TLowerBound</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hydrodynamics</span><span class="o">.</span><span class="n">Tnucl</span> <span class="o">-</span> <span class="n">Tplus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">TMultiplier</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Tminus</span> <span class="o">/</span> <span class="n">tempAtMinimum</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>

        <span class="n">testTemp</span> <span class="o">=</span> <span class="n">tempAtMinimum</span> <span class="o">*</span> <span class="n">TMultiplier</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperatureProfileEqLHS</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">dPhidz</span><span class="p">,</span> <span class="n">testTemp</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="c1">## No solution was found. We return 0.</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">tempAtMinimum</span> <span class="o">*=</span> <span class="n">TMultiplier</span>
            <span class="n">testTemp</span> <span class="o">*=</span> <span class="n">TMultiplier</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Solving for the root</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">root_scalar</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">T</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperatureProfileEqLHS</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">dPhidz</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">),</span>
            <span class="n">bracket</span><span class="o">=</span><span class="p">(</span><span class="n">tempAtMinimum</span><span class="p">,</span> <span class="n">testTemp</span><span class="p">),</span>
            <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
            <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errTol</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">root</span>

        <span class="n">T</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">vPlasma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plasmaVelocity</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">vPlasma</span></div>


<div class="viewcode-block" id="EOM.plasmaVelocity">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.plasmaVelocity">[docs]</a>
    <span class="k">def</span> <span class="nf">plasmaVelocity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">FieldPoint</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">s1</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the plasma velocity as a function of the temperature.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fields : FieldPoint</span>
<span class="sd">            Scalar field profiles.</span>
<span class="sd">        T : float</span>
<span class="sd">            Temperature.</span>
<span class="sd">        s1 : float</span>
<span class="sd">            Value of :math:`T^{30}-T_{\rm out}^{30}`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Plasma velocity.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Need enthalpy ouside a free-energy minimum (eq .(12) in arXiv:2204.13120v1)</span>
        <span class="n">enthalpy</span> <span class="o">=</span> <span class="o">-</span><span class="n">T</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">effectivePotential</span><span class="o">.</span><span class="n">derivT</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="o">-</span><span class="n">enthalpy</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">enthalpy</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">s1</span><span class="p">))</span></div>


<div class="viewcode-block" id="EOM.temperatureProfileEqLHS">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.temperatureProfileEqLHS">[docs]</a>
    <span class="k">def</span> <span class="nf">temperatureProfileEqLHS</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">FieldPoint</span><span class="p">,</span>
        <span class="n">dPhidz</span><span class="p">:</span> <span class="n">FieldPoint</span><span class="p">,</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">s1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">s2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The LHS of Eq. (20) of arXiv:2204.13120v1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fields : FieldPoint</span>
<span class="sd">            Scalar field profile.</span>
<span class="sd">        dPhidz : FieldPoint</span>
<span class="sd">            Derivative with respect to the position of the scalar field profile.</span>
<span class="sd">        T : float</span>
<span class="sd">            Temperature.</span>
<span class="sd">        s1 : float</span>
<span class="sd">            Value of :math:`T^{30}-T_{\rm out}^{30}`.</span>
<span class="sd">        s2 : float</span>
<span class="sd">            Value of :math:`T^{33}-T_{\rm out}^{33}`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            LHS of Eq. (20) of arXiv:2204.13120v1.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Need enthalpy ouside a free-energy minimum (eq (12) in the ref.)</span>
        <span class="n">enthalpy</span> <span class="o">=</span> <span class="o">-</span><span class="n">T</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">effectivePotential</span><span class="o">.</span><span class="n">derivT</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="n">kineticTerm</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dPhidz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="c1">## eff potential at this field point and temperature. NEEDS the T-dep constant</span>
        <span class="n">veff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">effectivePotential</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">kineticTerm</span>
            <span class="o">-</span> <span class="n">veff</span>
            <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">enthalpy</span>
            <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">enthalpy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">s2</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LHS has wrong type, </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="EOM.deltaToTmunu">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.deltaToTmunu">[docs]</a>
    <span class="k">def</span> <span class="nf">deltaToTmunu</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">FieldPoint</span><span class="p">,</span>
        <span class="n">velocityMid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">offEquilDeltas</span><span class="p">:</span> <span class="n">BoltzmannDeltas</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the out-of-equilibrium part of the energy-momentum tensor. See eq. (14)</span>
<span class="sd">        of arXiv:2204.13120v1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index of the grid point on which to find the plasma profile.</span>
<span class="sd">        fields : FieldPoint</span>
<span class="sd">            Scalar field profile.</span>
<span class="sd">        velocityMid : float</span>
<span class="sd">            Midpoint of plasma velocity in the wall frame, :math:`(v_+ + v_-)/2`.</span>
<span class="sd">        offEquilDeltas : BoltzmannDeltas</span>
<span class="sd">            BoltzmannDeltas object containing the off-equilibrium Delta functions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        T30 : float</span>
<span class="sd">            Out-of-equilibrium part of :math:`T^{30}`.</span>
<span class="sd">        T33 : float</span>
<span class="sd">            Out-of-equilibrium part of :math:`T^{33}`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Delta00</span> <span class="o">=</span> <span class="n">offEquilDeltas</span><span class="o">.</span><span class="n">Delta00</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span>  <span class="c1"># pylint: disable=invalid-name</span>
            <span class="p">:,</span> <span class="n">index</span>
        <span class="p">]</span>
        <span class="n">Delta02</span> <span class="o">=</span> <span class="n">offEquilDeltas</span><span class="o">.</span><span class="n">Delta02</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span>  <span class="c1"># pylint: disable=invalid-name</span>
            <span class="p">:,</span> <span class="n">index</span>
        <span class="p">]</span>
        <span class="n">Delta20</span> <span class="o">=</span> <span class="n">offEquilDeltas</span><span class="o">.</span><span class="n">Delta20</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span>  <span class="c1"># pylint: disable=invalid-name</span>
            <span class="p">:,</span> <span class="n">index</span>
        <span class="p">]</span>
        <span class="n">Delta11</span> <span class="o">=</span> <span class="n">offEquilDeltas</span><span class="o">.</span><span class="n">Delta11</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span>  <span class="c1"># pylint: disable=invalid-name</span>
            <span class="p">:,</span> <span class="n">index</span>
        <span class="p">]</span>

        <span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gammaSq</span><span class="p">(</span><span class="n">velocityMid</span><span class="p">))</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gammaSq</span><span class="p">(</span><span class="n">velocityMid</span><span class="p">))</span> <span class="o">*</span> <span class="n">velocityMid</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">ubar0</span> <span class="o">=</span> <span class="n">u3</span>
        <span class="n">ubar3</span> <span class="o">=</span> <span class="n">u0</span>

        <span class="c1"># Computing the out-of-equilibrium part of the energy-momentum tensor</span>
        <span class="n">T30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">totalDOFs</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="o">+</span><span class="p">(</span>
                        <span class="mi">3</span> <span class="o">*</span> <span class="n">Delta20</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">Delta02</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">particle</span><span class="o">.</span><span class="n">msqVacuum</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">*</span> <span class="n">Delta00</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="n">u3</span>
                    <span class="o">*</span> <span class="n">u0</span>
                    <span class="o">+</span> <span class="p">(</span>
                        <span class="mi">3</span> <span class="o">*</span> <span class="n">Delta02</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">Delta20</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">particle</span><span class="o">.</span><span class="n">msqVacuum</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">*</span> <span class="n">Delta00</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="n">ubar3</span>
                    <span class="o">*</span> <span class="n">ubar0</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Delta11</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u3</span> <span class="o">*</span> <span class="n">ubar0</span> <span class="o">+</span> <span class="n">ubar3</span> <span class="o">*</span> <span class="n">u0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="mf">2.0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">T33</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">totalDOFs</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="o">+</span><span class="p">(</span>
                            <span class="mi">3</span> <span class="o">*</span> <span class="n">Delta20</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">Delta02</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">particle</span><span class="o">.</span><span class="n">msqVacuum</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">*</span> <span class="n">Delta00</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="o">*</span> <span class="n">u3</span>
                        <span class="o">*</span> <span class="n">u3</span>
                        <span class="o">+</span> <span class="p">(</span>
                            <span class="mi">3</span> <span class="o">*</span> <span class="n">Delta02</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">Delta20</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">particle</span><span class="o">.</span><span class="n">msqVacuum</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">*</span> <span class="n">Delta00</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="o">*</span> <span class="n">ubar3</span>
                        <span class="o">*</span> <span class="n">ubar3</span>
                        <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">Delta11</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">u3</span> <span class="o">*</span> <span class="n">ubar3</span>
                    <span class="p">)</span>
                    <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="o">-</span> <span class="p">(</span>
                        <span class="n">particle</span><span class="o">.</span><span class="n">msqVacuum</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">*</span> <span class="n">Delta00</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">Delta02</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">Delta20</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">/</span> <span class="mf">2.0</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">T30</span><span class="p">,</span> <span class="n">T33</span></div>


<div class="viewcode-block" id="EOM.getBoltzmannFiniteDifference">
<a class="viewcode-back" href="../../modules/equationOfMotion.html#WallGo.EOM.getBoltzmannFiniteDifference">[docs]</a>
    <span class="k">def</span> <span class="nf">getBoltzmannFiniteDifference</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoltzmannResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mostly to estimate errors, recomputes Boltzmann stuff</span>
<span class="sd">        using finite difference derivatives.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># finite difference method requires everything to be in</span>
        <span class="c1"># the Cardinal basis</span>
        <span class="n">boltzmannSolverFiniteDifference</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boltzmannSolver</span><span class="p">)</span>
        <span class="n">boltzmannSolverFiniteDifference</span><span class="o">.</span><span class="n">derivatives</span> <span class="o">=</span> <span class="s2">&quot;Finite Difference&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">boltzmannSolverFiniteDifference</span><span class="o">.</span><span class="n">basisM</span> <span class="o">==</span> <span class="s2">&quot;Cardinal&quot;</span>
        <span class="p">),</span> <span class="s2">&quot;Error in boltzmannFiniteDifference: must be in Cardinal basis&quot;</span>
        <span class="n">boltzmannSolverFiniteDifference</span><span class="o">.</span><span class="n">basisN</span> <span class="o">=</span> <span class="s2">&quot;Cardinal&quot;</span>
        <span class="n">boltzmannSolverFiniteDifference</span><span class="o">.</span><span class="n">collisionArray</span><span class="o">.</span><span class="n">changeBasis</span><span class="p">(</span><span class="s2">&quot;Cardinal&quot;</span><span class="p">)</span>
        <span class="c1"># now computing results</span>
        <span class="k">return</span> <span class="n">boltzmannSolverFiniteDifference</span><span class="o">.</span><span class="n">getDeltas</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Andreas Ekstedt, Oliver Gould, Joonas Hirvonen, Benoit Laurent, Lauri Niemi, Philipp Schicho, and Jorinde van de Vis.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>